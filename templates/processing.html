<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>X·ª≠ l√Ω th√¥ng tin b·ªánh nh√¢n | H·ªá th·ªëng ƒêi·ªÅu ph·ªëi</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.svg') }}" type="image/svg+xml">
</head>
<body>
    <div class="container-fluid">
        <div class="row bg-primary text-white p-3">
            <div class="col">
                <h2>H·ªá Th·ªëng ƒêi·ªÅu Ph·ªëi B·ªánh Nh√¢n</h2>
                <p>ƒêang x·ª≠ l√Ω th√¥ng tin b·ªánh nh√¢n trong h·ªá th·ªëng ƒëa agent...</p>
            </div>
        </div>
        
        <div class="row mt-3">
            <div class="col-md-4">
                <div class="card mb-3">
                    <div class="card-header bg-info text-white">
                        <h5 class="card-title">Th√¥ng tin b·ªánh nh√¢n</h5>
                    </div>
                    <div class="card-body" id="patient-info">
                        <div class="mb-3">
                            <strong>ID:</strong> <span id="patient-id">{{ patient_id }}</span>
                        </div>
                        <div class="mb-3">
                            <strong>M√¥ t·∫£:</strong> 
                            <p id="patient-description">{{ description }}</p>
                        </div>
                        <div class="mb-3">
                            <strong>V·ªã tr√≠:</strong> 
                            <p id="patient-location">Vƒ© ƒë·ªô: {{ location.latitude }}, Kinh ƒë·ªô: {{ location.longitude }}</p>
                        </div>
                        {% if medical_history %}
                        <div class="mb-3">
                            <strong>Ti·ªÅn s·ª≠:</strong> 
                            <p id="patient-history">{{ medical_history }}</p>
                        </div>
                        {% endif %}
                        <div class="mb-3">
                            <strong>Th·ªùi gian kh·ªüi ph√°t:</strong> 
                            <p id="onset-time">{{ onset_time }}</p>
                        </div>
                        {% if vitals %}
                        <div class="mb-3">
                            <strong>D·∫•u hi·ªáu sinh t·ªìn:</strong> 
                            <p id="patient-vitals">{{ vitals }}</p>
                        </div>
                        {% endif %}
                        <div class="mb-3">
                            <strong>Tr·∫°ng th√°i:</strong> 
                            <span id="emergency-status" class="badge {% if is_emergency %}bg-danger{% else %}bg-warning{% endif %}">
                                {% if is_emergency %}Kh·∫©n c·∫•p{% else %}Th√¥ng th∆∞·ªùng{% endif %}
                            </span>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title">Ti·∫øn tr√¨nh x·ª≠ l√Ω</h5>
                    </div>
                    <div class="card-body">
                        <div id="processing-timeline" class="timeline">
                            <!-- Triage Agent -->
                            <div class="timeline-item" id="triage-step">
                                <div class="timeline-badge bg-primary">
                                    <i class="bi bi-1-circle"></i>
                                </div>
                                <div class="timeline-panel">
                                    <div class="timeline-heading">
                                        <h4 class="timeline-title">Triage Agent</h4>
                                        <p><small class="text-muted" id="triage-time">ƒêang ƒë·ª£i...</small></p>
                                    </div>
                                    <div class="timeline-body">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span>ƒêang ph√¢n t√≠ch th√¥ng tin b·ªánh nh√¢n...</span>
                                        <div id="triage-result" class="mt-2 d-none">
                                            <!-- K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                        </div>
                                        <div id="triage-reasoning" class="mt-2">
                                            <!-- Reasoning s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                              <!-- Patient Care Agent -->
                            <div class="timeline-item" id="patient-care-step">
                                <div class="timeline-badge bg-secondary">
                                    <i class="bi bi-2-circle"></i>
                                </div>
                                <div class="timeline-panel">
                                    <div class="timeline-heading">
                                        <h4 class="timeline-title">Patient Care Agent</h4>
                                        <p><small class="text-muted" id="patient-care-time">ƒêang ƒë·ª£i...</small></p>
                                    </div>
                                    <div class="timeline-body">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span>ƒêang ph√¢n lu·ªìng b·ªánh nh√¢n...</span>
                                        <div id="patient-care-result" class="mt-2 d-none">
                                            <!-- K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Hospital Agent -->
                            <div class="timeline-item" id="hospital-step">
                                <div class="timeline-badge bg-info">
                                    <i class="bi bi-3-circle"></i>
                                </div>
                                <div class="timeline-panel">
                                    <div class="timeline-heading">
                                        <h4 class="timeline-title">Hospital Agent</h4>
                                        <p><small class="text-muted" id="hospital-time">ƒêang ƒë·ª£i...</small></p>
                                    </div>
                                    <div class="timeline-body">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span>Ch·ªù k·∫øt qu·∫£ ph√¢n lo·∫°i...</span>
                                        <div id="hospital-result" class="mt-2 d-none">
                                            <!-- K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                        </div>
                                        <div id="hospital-reasoning" class="mt-2">
                                            <!-- Reasoning s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Dispatch Agent -->                            <div class="timeline-item" id="dispatch-step">
                                <div class="timeline-badge bg-secondary">
                                    <i class="bi bi-4-circle"></i>
                                </div>
                                <div class="timeline-panel">
                                    <div class="timeline-heading">
                                        <h4 class="timeline-title">Dispatch Agent</h4>
                                        <p><small class="text-muted" id="dispatch-time">ƒêang ƒë·ª£i...</small></p>
                                    </div>
                                    <div class="timeline-body">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span>Ch·ªù k·∫øt qu·∫£ ph√¢n lo·∫°i...</span>
                                        <div id="dispatch-result" class="mt-2 d-none">
                                            <!-- K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Optimizer Agent -->                            <div class="timeline-item" id="optimizer-step">
                                <div class="timeline-badge bg-secondary">
                                    <i class="bi bi-5-circle"></i>
                                </div>
                                <div class="timeline-panel">
                                    <div class="timeline-heading">
                                        <h4 class="timeline-title">Optimizer Agent</h4>
                                        <p><small class="text-muted" id="optimizer-time">ƒêang ƒë·ª£i...</small></p>
                                    </div>
                                    <div class="timeline-body">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span>Ch·ªù k·∫øt qu·∫£ t·ª´ c√°c agent kh√°c...</span>
                                        <div id="optimizer-result" class="mt-2 d-none">
                                            <!-- K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                        </div>
                                        <div id="optimizer-reasoning" class="mt-2">
                                            <!-- Reasoning s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Final Results -->
                            <div class="timeline-item" id="final-step">
                                <div class="timeline-badge bg-secondary">
                                    <i class="bi bi-flag-fill"></i>
                                </div>
                                <div class="timeline-panel">
                                    <div class="timeline-heading">
                                        <h4 class="timeline-title">K·∫øt qu·∫£</h4>
                                        <p><small class="text-muted" id="final-time">ƒêang ƒë·ª£i...</small></p>
                                    </div>
                                    <div class="timeline-body">
                                        <div class="spinner-border spinner-border-sm" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                        <span>Ch·ªù ho√†n th√†nh t·∫•t c·∫£ quy tr√¨nh...</span>
                                        <div id="final-result" class="mt-2 d-none">
                                            <!-- K·∫øt qu·∫£ s·∫Ω hi·ªÉn th·ªã ·ªü ƒë√¢y -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row mt-3 mb-5">
            <div class="col-md-12 text-center">
                <div id="progress-indicator" class="progress mb-3" style="height: 25px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%;" id="progress-bar">0%</div>
                </div>
                <div id="processing-message">ƒêang b·∫Øt ƒë·∫ßu x·ª≠ l√Ω th√¥ng tin b·ªánh nh√¢n...</div>
                <div class="mt-3 d-none" id="result-actions">
                    <a href="/results" class="btn btn-success">Xem k·∫øt qu·∫£ chi ti·∫øt</a>
                    <a href="/" class="btn btn-primary">Quay l·∫°i trang ch·ªß</a>
                </div>
            </div>
        </div>
    </div>    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.1/socket.io.min.js"></script>
    <script src="{{ url_for('static', filename='js/patient-care-handler.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // K·∫øt n·ªëi Socket.IO
            const socket = io();
            const flowId = "{{ flow_id }}";
            let currentStep = 0;
            const totalSteps = 5; // Triage, Hospital, Dispatch, Optimizer, Final
            
            // X·ª≠ l√Ω ti·∫øn tr√¨nh
            function updateProgress(step, data) {
                currentStep = step;
                const percent = Math.min(Math.round((step / totalSteps) * 100), 100);
                document.getElementById('progress-bar').style.width = percent + '%';
                document.getElementById('progress-bar').textContent = percent + '%';
                
                // C·∫≠p nh·∫≠t c√°c timeline item
                switch(step) {
                    case 1: // Triage
                        updateStep('triage', 'bg-success', data);
                        break;
                    case 2: // Hospital
                        updateStep('hospital', 'bg-success', data);
                        document.getElementById('hospital-step').querySelector('.timeline-badge').classList.remove('bg-secondary');
                        document.getElementById('hospital-step').querySelector('.timeline-badge').classList.add('bg-primary');
                        break;
                    case 3: // Dispatch
                        updateStep('dispatch', 'bg-success', data);
                        document.getElementById('dispatch-step').querySelector('.timeline-badge').classList.remove('bg-secondary');
                        document.getElementById('dispatch-step').querySelector('.timeline-badge').classList.add('bg-primary');
                        break;
                    case 4: // Optimizer
                        updateStep('optimizer', 'bg-success', data);
                        document.getElementById('optimizer-step').querySelector('.timeline-badge').classList.remove('bg-secondary');
                        document.getElementById('optimizer-step').querySelector('.timeline-badge').classList.add('bg-primary');
                        break;
                    case 5: // Final
                        updateStep('final', 'bg-success', data);
                        document.getElementById('final-step').querySelector('.timeline-badge').classList.remove('bg-secondary');
                        document.getElementById('final-step').querySelector('.timeline-badge').classList.add('bg-primary');
                        
                        // Hi·ªÉn th·ªã n√∫t k·∫øt qu·∫£
                        document.getElementById('result-actions').classList.remove('d-none');
                        document.getElementById('processing-message').textContent = 'X·ª≠ l√Ω ho√†n t·∫•t!';
                        break;
                }
            }
            
            function updateStep(stepId, badgeClass, data) {
                const stepElement = document.getElementById(stepId + '-step');
                const resultElement = document.getElementById(stepId + '-result');
                const timeElement = document.getElementById(stepId + '-time');
                
                // C·∫≠p nh·∫≠t th·ªùi gian
                timeElement.textContent = new Date().toLocaleTimeString();
                
                // ·∫®n spinner
                stepElement.querySelector('.spinner-border').classList.add('d-none');
                
                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                resultElement.classList.remove('d-none');
                
                // Th√™m n·ªôi dung k·∫øt qu·∫£ t√πy thu·ªôc v√†o lo·∫°i agent
                if (data) {
                    let resultHTML = '';
                    
                    switch(stepId) {
                        case 'triage':
                            resultHTML = `
                                <div class="alert alert-info">
                                    <strong>Tri·ªáu ch·ª©ng:</strong> ${data.symptoms ? data.symptoms.map(s => s.name).join(', ') : 'Kh√¥ng x√°c ƒë·ªãnh'}<br>
                                    <strong>M·ª©c ƒë·ªô ∆∞u ti√™n:</strong> ${data.priority || 'Kh√¥ng x√°c ƒë·ªãnh'}<br>
                                    <strong>Chuy√™n khoa:</strong> ${data.specialty || 'Kh√¥ng x√°c ƒë·ªãnh'}<br>
                                    <strong>C·∫ßn c·∫•p c·ª©u:</strong> ${data.needs_emergency ? 'C√≥' : 'Kh√¥ng'}
                                </div>
                            `;
                            break;
                        case 'hospital':
                            if (data.hospitals && data.hospitals.length > 0) {
                                resultHTML = `<div class="alert alert-info"><strong>ƒê√£ t√¨m th·∫•y ${data.hospitals.length} b·ªánh vi·ªán ph√π h·ª£p:</strong><ul>`;
                                data.hospitals.forEach((hospital, i) => {
                                    resultHTML += `<li>${hospital.name} (${hospital.distance_km} km)</li>`;
                                });
                                resultHTML += `</ul></div>`;
                            } else {
                                resultHTML = `<div class="alert alert-warning">Kh√¥ng t√¨m th·∫•y b·ªánh vi·ªán ph√π h·ª£p</div>`;
                            }
                            break;
                        case 'dispatch':
                            if (data.ambulances && data.ambulances.length > 0) {
                                resultHTML = `<div class="alert alert-info"><strong>ƒê√£ t√¨m th·∫•y ${data.ambulances.length} xe c·ª©u th∆∞∆°ng:</strong><ul>`;
                                data.ambulances.forEach((ambulance, i) => {
                                    resultHTML += `<li>${ambulance.name} - ETA: ${ambulance.eta_minutes} ph√∫t</li>`;
                                });
                                resultHTML += `</ul></div>`;
                            } else {
                                resultHTML = `<div class="alert alert-warning">Kh√¥ng t√¨m th·∫•y xe c·ª©u th∆∞∆°ng</div>`;
                            }
                            break;
                        case 'optimizer':
                            resultHTML = `
                                <div class="alert alert-success">
                                    <strong>B·ªánh vi·ªán t·ªëi ∆∞u:</strong> ${data.optimized_hospital ? data.optimized_hospital.name : 'Kh√¥ng c√≥'}<br>
                                    <strong>Xe c·ª©u th∆∞∆°ng t·ªëi ∆∞u:</strong> ${data.optimized_ambulance ? data.optimized_ambulance.name : 'Kh√¥ng c√≥'}<br>
                                    <strong>Th·ªùi gian d·ª± ki·∫øn:</strong> ${data.eta_minutes || 'N/A'} ph√∫t
                                </div>
                            `;
                            break;
                        case 'final':
                            resultHTML = `
                                <div class="alert alert-success">
                                    <strong>X·ª≠ l√Ω th√†nh c√¥ng!</strong><br>
                                    ƒê√£ ch·ªçn ${data.optimized_hospital ? data.optimized_hospital.name : 'ch∆∞a c√≥ b·ªánh vi·ªán'}<br>
                                    ƒê√£ ƒëi·ªÅu ƒë·ªông ${data.optimized_ambulance ? data.optimized_ambulance.name : 'ch∆∞a c√≥ xe c·ª©u th∆∞∆°ng'}<br>
                                    Th·ªùi gian ƒë·∫øn d·ª± ki·∫øn: ${data.estimated_arrival_time || 'Kh√¥ng x√°c ƒë·ªãnh'}
                                </div>
                                <a href="/results" class="btn btn-primary">Xem k·∫øt qu·∫£ chi ti·∫øt</a>
                            `;
                            break;
                    }
                    
                    resultElement.innerHTML = resultHTML;
                }
                
                // C·∫≠p nh·∫≠t message
                if (stepId === 'final') {
                    document.getElementById('processing-message').textContent = 'X·ª≠ l√Ω ho√†n t·∫•t!';
                } else {
                    const nextStep = {
                        'triage': 'ƒêang t√¨m b·ªánh vi·ªán ph√π h·ª£p...',
                        'hospital': 'ƒêang t√¨m xe c·ª©u th∆∞∆°ng...',
                        'dispatch': 'ƒêang t·ªëi ∆∞u h√≥a k·∫øt qu·∫£...',
                        'optimizer': 'ƒêang ho√†n thi·ªán k·∫øt qu·∫£...'
                    };
                    document.getElementById('processing-message').textContent = nextStep[stepId] || '';
                }
            }
            
            // L·∫Øng nghe s·ª± ki·ªán t·ª´ server
            socket.on('connect', function() {
                console.log('Connected to server');
                socket.emit('join_room', { flow_id: flowId });
            });
              socket.on('triage_update', function(data) {
                updateProgress(1, data);
            });
            
            socket.on('patient_care_update', function(data) {
                updateProgress(2, data);
            });
            
            socket.on('hospital_update', function(data) {
                console.log('Hospital update:', data);
                
                // Update UI
                const hospitalStep = document.getElementById('hospital-step');
                const hospitalResult = document.getElementById('hospital-result');
                const hospitalTime = document.getElementById('hospital-time');
                
                if (hospitalStep) {
                    hospitalStep.querySelector('.timeline-badge').className = 'timeline-badge bg-success';
                    hospitalStep.querySelector('.spinner-border').style.display = 'none';
                }
                
                if (hospitalTime) {
                    hospitalTime.textContent = new Date().toLocaleTimeString();
                }
                
                if (hospitalResult) {
                    hospitalResult.classList.remove('d-none');
                    hospitalResult.innerHTML = `
                        <div class="alert alert-success">
                            <strong>K·∫øt qu·∫£ t√¨m ki·∫øm b·ªánh vi·ªán:</strong><br>
                            <strong>B·ªánh vi·ªán ƒë·ªÅ xu·∫•t:</strong> ${data.recommended_hospital}<br>
                            <strong>S·ªë l∆∞·ª£ng b·ªánh vi·ªán kh·∫£ d·ª•ng:</strong> ${data.available_hospitals ? data.available_hospitals.length : 0}
                        </div>
                    `;
                    
                    // Display reasoning if available
                    if (data.reasoning) {
                        displayReasoning('hospital-reasoning', data.reasoning);
                    }
                }
                
                // Auto-proceed to next step
                setTimeout(() => {
                    startOptimizer();
                }, 1000);
            });
            
            socket.on('dispatch_update', function(data) {
                updateProgress(4, data);
            });
            
            socket.on('optimizer_update', function(data) {
                updateProgress(5, data);
                
                // Check if we need to redirect to chatbot
                if (data.redirect_to_chatbot && data.chatbot_url) {
                    setTimeout(function() {
                        window.location.href = data.chatbot_url;
                    }, 3000); // Give time for the user to see the completion
                }
            });
            
            socket.on('flow_completed', function(data) {
                updateProgress(6, data);
                
                console.log('Flow completed:', data);
                  // Show completion message
                const completionStep = document.getElementById('final-step');
                if (completionStep) {
                    completionStep.querySelector('.timeline-badge').className = 'timeline-badge bg-success';
                    completionStep.querySelector('.spinner-border').style.display = 'none';
                    completionStep.querySelector('.timeline-body').innerHTML = `
                        <div class="alert alert-success">
                            <i class="bi bi-check-circle"></i> Ho√†n th√†nh ƒëi·ªÅu ph·ªëi b·ªánh nh√¢n!
                            <br><small>Chuy·ªÉn h∆∞·ªõng ƒë·∫øn trang t·ªïng h·ª£p...</small>
                        </div>
                    `;
                }
                
                // Redirect to dashboard after 3 seconds
                setTimeout(() => {
                    window.location.href = data.redirect_url || '/dashboard';
                }, 3000);
            });
            
            // Simulate updates for demo if needed
            {% if simulate_updates %}
            simulateUpdates();
            {% endif %}
              function simulateUpdates() {
                // Simulate triage
                setTimeout(() => {
                    updateProgress(1, {
                        symptoms: [
                            {name: "B·∫•t t·ªânh", severity: "Cao"},
                            {name: "Da t√°i", severity: "Cao"},
                            {name: "M·ªì h√¥i l·∫°nh", severity: "Trung b√¨nh"}
                        ],
                        priority: 5,
                        specialty: "Tim m·∫°ch",
                        needs_emergency: true
                    });
                }, 2000);
                
                // Simulate patient care agent
                setTimeout(() => {
                    // Simulate the patient care update
                    const patientCareData = {
                        route_to: "emergency",
                        action: "dispatch_ambulance",
                        message: "ƒê√¢y l√† tr∆∞·ªùng h·ª£p kh·∫©n c·∫•p, ƒëang ƒëi·ªÅu ph·ªëi xe c·ª©u th∆∞∆°ng v√† b·ªánh vi·ªán.",
                        patient_id: "P12345"
                    };
                    
                    // Manual update for patient care step
                    document.getElementById('patient-care-step').classList.add('timeline-item-active');
                    document.getElementById('patient-care-time').textContent = new Date().toLocaleTimeString();
                    
                    // Remove spinner
                    const patientCareBody = document.getElementById('patient-care-step').querySelector('.timeline-body');
                    patientCareBody.innerHTML = "";
                    
                    const resultDiv = document.getElementById('patient-care-result');
                    resultDiv.classList.remove('d-none');
                    
                    // Format patient care results
                    let routeText = "";
                    let routeClass = "";
                    
                    switch(patientCareData.route_to) {
                        case 'chatbot':
                            routeText = "T∆∞ v·∫•n tr·ª±c tuy·∫øn";
                            routeClass = "info";
                            break;
                        case 'hospital':
                            routeText = "B·ªánh vi·ªán";
                            routeClass = "warning";
                            break;
                        case 'emergency':
                            routeText = "C·∫•p c·ª©u";
                            routeClass = "danger";
                            break;
                        default:
                            routeText = "Kh√¥ng x√°c ƒë·ªãnh";
                            routeClass = "secondary";
                    }
                    
                    let resultHTML = `
                        <div class="alert alert-${routeClass} mb-2">
                            <strong>Quy·∫øt ƒë·ªãnh:</strong> ${patientCareData.message || 'ƒêang ph√¢n lu·ªìng b·ªánh nh√¢n'}
                        </div>
                        <strong>ƒêi·ªÅu h∆∞·ªõng ƒë·∫øn:</strong> <span class="badge bg-${routeClass}">${routeText}</span><br>
                    `;
                    
                    resultDiv.innerHTML = resultHTML;
                    patientCareBody.appendChild(resultDiv);
                    
                    // Update progress bar
                    document.getElementById('progress-bar').style.width = '40%';
                    document.getElementById('progress-bar').textContent = '40%';
                }, 3000);
                  // Simulate hospital
                setTimeout(() => {
                    updateProgress(3, {
                        hospitals: [
                            {id: "H001", name: "B·ªánh vi·ªán Ch·ª£ R·∫´y", distance_km: 2.3, specialty_match: true},
                            {id: "H003", name: "B·ªánh vi·ªán Nh√¢n D√¢n Gia ƒê·ªãnh", distance_km: 5.1, specialty_match: true}
                        ],
                        is_emergency: true
                    });
                }, 5000);
                
                // Simulate dispatch
                setTimeout(() => {
                    updateProgress(4, {
                        ambulances: [
                            {id: "A001", name: "Xe c·ª©u th∆∞∆°ng 1", eta_minutes: 7},
                            {id: "A002", name: "Xe c·ª©u th∆∞∆°ng 2", eta_minutes: 12}
                        ],
                        is_emergency: true
                    });
                }, 7000);
                  // Simulate optimizer
                setTimeout(() => {
                    updateProgress(5, {
                        optimized_hospital: {id: "H001", name: "B·ªánh vi·ªán Ch·ª£ R·∫´y"},
                        optimized_ambulance: {id: "A001", name: "Xe c·ª©u th∆∞∆°ng 1"},
                        eta_minutes: 7,
                        route_to: "emergency"
                    });
                }, 9000);
                
                // Simulate final
                setTimeout(() => {
                    updateProgress(6, {
                        optimized_hospital: {id: "H001", name: "B·ªánh vi·ªán Ch·ª£ R·∫´y"},
                        optimized_ambulance: {id: "A001", name: "Xe c·ª©u th∆∞∆°ng 1"},
                        eta_minutes: 7,
                        estimated_arrival_time: "14:25",
                        route_to: "emergency"
                    });
                }, 11000);
            }
        });
    </script>
    <!-- Add reasoning display functionality -->
        <script>
            function displayReasoning(elementId, reasoning) {
                const element = document.getElementById(elementId);
                if (element && reasoning) {
                    // Convert markdown-style formatting to HTML
                    const formattedReasoning = reasoning
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                        .replace(/üîç|üè•|üìã|üéØ/g, '<span class="me-1">$&</span>')
                        .replace(/- (.*)/g, '<li>$1</li>')
                        .replace(/\n/g, '<br>');
                    
                    element.innerHTML = `
                        <div class="alert alert-info mt-3">
                            <h6><i class="bi bi-lightbulb"></i> L√Ω do quy·∫øt ƒë·ªãnh:</h6>
                            <div class="reasoning-content">${formattedReasoning}</div>
                        </div>
                    `;
                }
            }

            // Update existing socket handlers
            socket.on('triage_update', function(data) {
                console.log('Triage update:', data);
                
                // Update UI
                const triageStep = document.getElementById('triage-step');
                const triageResult = document.getElementById('triage-result');
                const triageTime = document.getElementById('triage-time');
                
                if (triageStep) {
                    triageStep.querySelector('.timeline-badge').className = 'timeline-badge bg-success';
                    triageStep.querySelector('.spinner-border').style.display = 'none';
                }
                
                if (triageTime) {
                    triageTime.textContent = new Date().toLocaleTimeString();
                }
                
                if (triageResult) {
                    triageResult.classList.remove('d-none');
                    triageResult.innerHTML = `
                        <div class="alert alert-success">
                            <strong>K·∫øt qu·∫£ ph√¢n t√≠ch:</strong><br>
                            <strong>M·ª©c ƒë·ªô ∆∞u ti√™n:</strong> ${data.priority}/5<br>
                            <strong>Chuy√™n khoa:</strong> ${data.specialty}<br>
                            <strong>C·∫ßn c·∫•p c·ª©u:</strong> ${data.needs_emergency ? 'C√≥' : 'Kh√¥ng'}
                        </div>
                    `;
                    
                    // Display reasoning if available
                    if (data.reasoning) {
                        displayReasoning('triage-reasoning', data.reasoning);
                    }
                }
                
                // Auto-proceed to next step
                setTimeout(() => {
                    startPatientCareStep();
                }, 1000);
            });

            socket.on('optimizer_update', function(data) {
                console.log('Optimizer update:', data);
                
                // Update UI
                const optimizerStep = document.getElementById('optimizer-step');
                const optimizerResult = document.getElementById('optimizer-result');
                const optimizerTime = document.getElementById('optimizer-time');
                
                if (optimizerStep) {
                    optimizerStep.querySelector('.timeline-badge').className = 'timeline-badge bg-success';
                    optimizerStep.querySelector('.spinner-border').style.display = 'none';
                }
                
                if (optimizerTime) {
                    optimizerTime.textContent = new Date().toLocaleTimeString();
                }
                
                if (optimizerResult) {
                    optimizerResult.classList.remove('d-none');
                    optimizerResult.innerHTML = `
                        <div class="alert alert-success">
                            <strong>K·∫øt qu·∫£ ƒëi·ªÅu ph·ªëi:</strong><br>
                            <strong>B·ªánh vi·ªán:</strong> ${data.selected_hospital}<br>
                            <strong>Th·ªùi gian d·ª± ki·∫øn:</strong> ${data.estimated_time}<br>
                            <strong>Xe c·∫•p c·ª©u:</strong> ${data.ambulance_assigned}
                        </div>
                    `;
                    
                    // Display reasoning if available
                    if (data.reasoning) {
                        displayReasoning('optimizer-reasoning', data.reasoning);
                    }
                }
                
                // Auto-proceed to completion
                setTimeout(() => {
                    completeProcessing();
                }, 2000);
            });
            
            socket.on('hospital_update', function(data) {
                console.log('Hospital update:', data);
                
                // Update UI
                const hospitalStep = document.getElementById('hospital-step');
                const hospitalResult = document.getElementById('hospital-result');
                const hospitalTime = document.getElementById('hospital-time');
                
                if (hospitalStep) {
                    hospitalStep.querySelector('.timeline-badge').className = 'timeline-badge bg-success';
                    hospitalStep.querySelector('.spinner-border').style.display = 'none';
                }
                
                if (hospitalTime) {
                    hospitalTime.textContent = new Date().toLocaleTimeString();
                }
                
                if (hospitalResult) {
                    hospitalResult.classList.remove('d-none');
                    hospitalResult.innerHTML = `
                        <div class="alert alert-success">
                            <strong>K·∫øt qu·∫£ t√¨m ki·∫øm b·ªánh vi·ªán:</strong><br>
                            <strong>B·ªánh vi·ªán ƒë·ªÅ xu·∫•t:</strong> ${data.recommended_hospital}<br>
                            <strong>S·ªë l∆∞·ª£ng b·ªánh vi·ªán kh·∫£ d·ª•ng:</strong> ${data.available_hospitals ? data.available_hospitals.length : 0}
                        </div>
                    `;
                    
                    // Display reasoning if available
                    if (data.reasoning) {
                        displayReasoning('hospital-reasoning', data.reasoning);
                    }
                }
                
                // Auto-proceed to next step
                setTimeout(() => {
                    startOptimizer();
                }, 1000);
            });
            
            function startPatientCareStep() {
                // Update patient care step to active
                const patientCareStep = document.getElementById('patient-care-step');
                if (patientCareStep) {
                    patientCareStep.querySelector('.timeline-badge').className = 'timeline-badge bg-primary';
                    patientCareStep.querySelector('.timeline-body span').textContent = 'ƒêang ph√¢n lu·ªìng b·ªánh nh√¢n...';
                }
                
                // Auto-proceed to hospital step after 2 seconds
                setTimeout(() => {
                    startHospitalStep();
                }, 2000);
            }

            function startHospitalStep() {
                // Update hospital step to active
                const hospitalStep = document.getElementById('hospital-step');
                if (hospitalStep) {
                    hospitalStep.querySelector('.timeline-badge').className = 'timeline-badge bg-primary';
                    hospitalStep.querySelector('.timeline-body span').textContent = 'ƒêang t√¨m ki·∫øm b·ªánh vi·ªán...';
                }
            }

            function startOptimizer() {
                // Update optimizer step to active
                const optimizerStep = document.getElementById('optimizer-step');
                if (optimizerStep) {
                    optimizerStep.querySelector('.timeline-badge').className = 'timeline-badge bg-primary';
                    optimizerStep.querySelector('.timeline-body span').textContent = 'ƒêang t·ªëi ∆∞u h√≥a ƒëi·ªÅu ph·ªëi...';
                }
            }

            function completeProcessing() {
                // Update final step
                const finalStep = document.getElementById('final-step');
                if (finalStep) {
                    finalStep.querySelector('.timeline-badge').className = 'timeline-badge bg-success';
                    finalStep.querySelector('.spinner-border').style.display = 'none';
                    finalStep.querySelector('.timeline-body span').textContent = 'Ho√†n th√†nh qu√° tr√¨nh ƒëi·ªÅu ph·ªëi!';
                }
            }

            // ...existing code...
        </script>
</body>
</html>
